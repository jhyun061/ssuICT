import os, io, json, time, textwrap, re, datetime, urllib.parse
import streamlit as st
from html import escape

# ================= ê¸°ë³¸ =================
st.set_page_config(page_title="ìê¸°ì†Œê°œì„œ ì½”ì¹˜", page_icon="ğŸ’¬", layout="wide")
st.markdown("<style>.main .block-container{max-width:480px}</style>", unsafe_allow_html=True)

# ================= í…Œë§ˆ =================
THEME = {
    "PRIMARY":"#0AA6A6","PRIMARY_DARK":"#087F7F",
    "ACCENT":"#00C2C2","SURFACE":"#F5FBFB",
    "TEXT_DARK":"#0F172A","RADIUS":"18px",
    "GRAD_L":"#0FBDBD","GRAD_R":"#099494"
}
try:
    with open("assets/theme.json","r",encoding="utf-8") as f:
        THEME.update(json.load(f))
except Exception:
    pass

# (ì˜µì…˜) ì™¸ë¶€ CSS ë¡œë“œ â€” ì—†ì–´ë„ ë¨
if os.path.exists("assets/figma.css"):
    with open("assets/figma.css","r",encoding="utf-8") as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

# í•µì‹¬ ìŠ¤íƒ€ì¼(í—¤ë”/ë§í’ì„ ) + í…Œë§ˆ í† í°
st.markdown(f"""
<style>
:root {{
  --primary:{THEME["PRIMARY"]}; --accent:{THEME["ACCENT"]};
  --surface:{THEME["SURFACE"]}; --radius:{THEME["RADIUS"]};
  --gradL:{THEME["GRAD_L"]}; --gradR:{THEME["GRAD_R"]};
}}
body,.stApp{{background:var(--surface);}}
.round-header{{margin:12px 0 8px;background:linear-gradient(135deg,var(--gradL),var(--gradR));
  color:#fff;border-radius:18px;padding:14px 18px;box-shadow:0 8px 20px rgba(0,0,0,.08)}}
.round-header__title{{font-weight:900;letter-spacing:.2px}}
.round-header__sub{{opacity:.95;font-size:12px;margin-top:4px}}
.bubble{{max-width:88%;margin:10px 12px}}
.bubble .bubble-text{{padding:10px 14px;border-radius:18px;display:inline-block}}
.bubble .bubble-time{{font-size:11px;color:#64748b;margin-top:4px}}
.bubble.bot .bubble-text{{background:#F3F4F6;border-radius:18px 18px 18px 4px}}
.bubble.me{{text-align:right}}
.bubble.me .bubble-text{{background:#E8FDFC;border-radius:18px 18px 4px 18px}}
</style>
""", unsafe_allow_html=True)

# ================= ìƒíƒœ =================
if "screen" not in st.session_state: st.session_state.screen = "onboarding"   # onboarding | main
if "tab"    not in st.session_state: st.session_state.tab = "chat"            # chat | settings | storage | detail
if "msgs"   not in st.session_state:
    st.session_state.msgs = [("bot","ì•ˆë…•í•˜ì„¸ìš”! ìê¸°ì†Œê°œì„œ ì‘ì„±ì„ ë„ì™€ë“œë¦´ê²Œìš”. ì–´ë–¤ íšŒì‚¬/ì§ë¬´ì— ì§€ì›í•˜ì‹œë‚˜ìš”?", None)]
if "settings" not in st.session_state:
    st.session_state.settings = {
        "provider":"demo","model":"gpt-4o-mini",
        "tone":"ì •ì¤‘í•˜ê³  ê°„ê²°í•œ","length":800,"temperature":0.7,
        "openai_key":"","gemini_key":"",
        "save_dir": os.path.expanduser("~/AI_CoverLetter_Storage")
    }

# ================= ìœ í‹¸ =================
def now_hhmm():
    return datetime.datetime.now().strftime("%p %I:%M").replace("AM","ì˜¤ì „").replace("PM","ì˜¤í›„")

def timestamp():
    return datetime.datetime.now().strftime("%Y%m%d_%H%M%S")

def slugify(name:str)->str:
    return (re.sub(r'[\\/:*?"<>|]',"_",name).strip() or "coverletter")

def header_card(title:str, subtitle:str=""):
    st.markdown(f"""
    <div class="round-header">
      <div class="round-header__title">{title}</div>
      {f'<div class="round-header__sub">{subtitle}</div>' if subtitle else ''}
    </div>""", unsafe_allow_html=True)

def safe_html(s: str) -> str:
    return escape(s).replace("\n", "<br/>")

# ---- SVG ì•„ì´ì½˜ ë‚´ì¥/ë¡œë“œ -> data URI ----
DEFAULT_SVG = {
    "chat":     """<svg viewBox="0 0 24 24" fill="#000"><path d="M4 4h16v12H7l-3 3V4z"/></svg>""",
    "settings": """<svg viewBox="0 0 24 24" fill="#000"><path d="M19.4 12.94a7.5 7.5 0 0 0 .05-.94 7.5 7.5 0 0 0-.05-.94l2.11-1.65a.5.5 0 0 0 .12-.64l-2-3.46a.5.5 0 0 0-.6-.22l-2.49 1a7.55 7.55 0 0 0-1.63-.94l-.38-2.65A.5.5 0 0 0 12 0h-4a.5.5 0 0 0-.5.42l-.38 2.65c-.58.23-1.12.53-1.63.94l-2.49-1a.5.5 0 0 0-.6.22l-2 3.46a.5.5 0 0 0 .12.64L3.6 11.06c-.03.31-.05.63-.05.94s.02.63.05.94L1.49 14.6a.5.5 0 0 0-.12.64l2 3.46a.5.5 0 0 0 .6.22l2.49-1c.51.41 1.05.71 1.63.94l.38 2.65A.5.5 0 0 0 8 22h4a.5.5 0 0 0 .5-.42l.38-2.65c.58-.23 1.12-.53 1.63-.94l2.49 1a.5.5 0 0 0 .6-.22l2-3.46a.5.5 0 0 0-.12-.64L19.4 12.94zM10 14a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>""",
    "storage":  """<svg viewBox="0 0 24 24" fill="#000"><path d="M10 4l2 2h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h6z"/></svg>""",
    "detail":   """<svg viewBox="0 0 24 24" fill="#000"><path d="M5 4h14v2H5V4zm0 7h14v2H5v-2zm0 7h14v2H5v-2z"/></svg>"""
}
def svg_data_uri(path_or_key:str, key:str=None)->str:
    if key is None:  # direct
        raw = path_or_key
    else:
        if os.path.exists(path_or_key):
            raw = open(path_or_key,"r",encoding="utf-8").read()
        else:
            raw = DEFAULT_SVG[key]
    raw = re.sub(r">\s+<","><",raw.strip())
    return f"data:image/svg+xml;utf8,{urllib.parse.quote(raw)}"

# ================= ì €ì¥/ë³€í™˜ =================
def ensure_dir(path:str)->tuple[bool,str]:
    try:
        os.makedirs(path, exist_ok=True)
        test = os.path.join(path,".write_test"); open(test,"w").write("ok"); os.remove(test)
        return True,"OK"
    except PermissionError: return False,"ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”."
    except Exception as e:  return False,f"ì˜¤ë¥˜: {e}"

def to_docx_bytes(text:str)->bytes:
    from docx import Document
    from docx.shared import Pt
    doc = Document()
    s = doc.styles["Normal"]; s.font.name = "Malgun Gothic"; s.font.size = Pt(11)
    for p in text.split("\n\n"): doc.add_paragraph(p)
    buf = io.BytesIO(); doc.save(buf); return buf.getvalue()

def _find_korean_font()->tuple[str,int] | tuple[None,None]:
    candidates = [
        ("assets/fonts/NanumGothic.ttf", None),
        ("/Library/Fonts/NanumGothic.ttf", None),
        ("/System/Library/Fonts/AppleSDGothicNeo.ttc", 0),
        ("/Library/Fonts/AppleGothic.ttf", None),
        ("/System/Library/Fonts/Supplemental/AppleGothic.ttf", None),
    ]
    for path, idx in candidates:
        if os.path.exists(path):
            return path, (idx if idx is not None else 0)
    return None, None

def to_pdf_bytes(text:str)->bytes:
    from reportlab.lib.pagesizes import A4
    from reportlab.pdfgen import canvas
    from reportlab.lib.units import mm
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont

    font_path, sub_idx = _find_korean_font()
    font_name = "KOR"
    if font_path:
        try:
            if font_path.lower().endswith(".ttc"):
                pdfmetrics.registerFont(TTFont(font_name, font_path, subfontIndex=sub_idx or 0))
            else:
                pdfmetrics.registerFont(TTFont(font_name, font_path))
        except Exception:
            font_path = None

    buf = io.BytesIO()
    c = canvas.Canvas(buf, pagesize=A4)
    w,h = A4; x,y = 20*mm, h-20*mm
    if font_path: c.setFont(font_name, 11)
    else: c.setFont("Helvetica", 11)

    max_chars = 45
    for line in text.split("\n"):
        wrapped_lines = textwrap.wrap(line, max_chars) or [""]
        for ln in wrapped_lines:
            c.drawString(x,y,ln); y -= 14
            if y < 20*mm:
                c.showPage()
                if font_path: c.setFont(font_name, 11)
                else: c.setFont("Helvetica", 11)
                y = h-20*mm
    c.save()
    return buf.getvalue()

def save_last_result_all(title_base:str, text:str)->list[str]:
    s = st.session_state.settings
    ok, msg = ensure_dir(s["save_dir"])
    if not ok:
        st.error(msg); return []
    base = slugify(title_base) + "_" + timestamp()
    paths = []
    p_txt = os.path.join(s["save_dir"], base + ".txt")
    with open(p_txt,"w",encoding="utf-8") as f: f.write(text)
    paths.append(p_txt)
    p_docx = os.path.join(s["save_dir"], base + ".docx")
    with open(p_docx,"wb") as f: f.write(to_docx_bytes(text))
    paths.append(p_docx)
    p_pdf = os.path.join(s["save_dir"], base + ".pdf")
    with open(p_pdf,"wb") as f: f.write(to_pdf_bytes(text))
    paths.append(p_pdf)
    return paths

# ================= ìƒì„± ëª¨ë¸ =================
def call_openai(prompt, sys, model, key, temperature):
    try:
        from openai import OpenAI
        client = OpenAI(api_key=key or os.getenv("OPENAI_API_KEY",""))
        r = client.chat.completions.create(
            model=model, temperature=float(temperature),
            messages=[{"role":"system","content":sys},{"role":"user","content":prompt}]
        )
        return r.choices[0].message.content
    except Exception:
        return None

def call_gemini(prompt, sys, model, key, temperature):
    try:
        import google.generativeai as genai
        genai.configure(api_key=key or os.getenv("GEMINI_API_KEY",""))
        m = genai.GenerativeModel(model_name=model, system_instruction=sys)
        r = m.generate_content(prompt, generation_config={"temperature": float(temperature)})
        return getattr(r,"text","").strip() or None
    except Exception:
        return None

def generate_cover_letter(user_text):
    s = st.session_state.settings
    sys = f"ë„ˆëŠ” ì¸ì‚¬ë‹´ë‹¹ì ì¶œì‹  ìê¸°ì†Œê°œì„œ ì½”ì¹˜ë‹¤. í†¤:{s['tone']}, ëª©í‘œ ê¸€ì ìˆ˜:{s['length']}ìë¡œ êµ¬ì¡°í™”í•´ ì‘ì„±í•´ë¼."
    t = s.get("temperature",0.7)
    if s["provider"]=="openai" and (s["openai_key"] or os.getenv("OPENAI_API_KEY")):
        out = call_openai(user_text, sys, s["model"], s["openai_key"], t)
        if out: return out
    if s["provider"]=="gemini" and (s["gemini_key"] or os.getenv("GEMINI_API_KEY")):
        out = call_gemini(user_text, sys, s["model"], s["gemini_key"], t)
        if out: return out
    return ("[DEMO]\n\n1) ì§€ì› ë™ê¸°\n2) í•µì‹¬ ì—­ëŸ‰/ì‚¬ë¡€\n3) í˜‘ì—…/ë¬¸ì œí•´ê²° ê²½í—˜\n4) ì…ì‚¬ í›„ í¬ë¶€\n\n"
            "JD í‚¤ì›Œë“œë¥¼ í•œ ì¤„ë¡œ ì•Œë ¤ì£¼ì„¸ìš”. (ì˜ˆ: ë°ì´í„° ë¶„ì„, SQL, ëŒ€ì‹œë³´ë“œ)")

# ================= ì…ë ¥/íƒ­ UI (í•˜ë‹¨ ê³ ì •) =================
def bottom_tabs(active="chat"):
    chat_uri     = svg_data_uri("assets/icons/chat.svg","chat")
    settings_uri = svg_data_uri("assets/icons/settings.svg","settings")
    storage_uri  = svg_data_uri("assets/icons/storage.svg","storage")
    detail_uri   = svg_data_uri("assets/icons/detail.svg","detail")

    tabs   = ["chat", "settings", "storage", "detail"]
    labels = {"chat":"ëŒ€í™”","settings":"ì„¤ì •","storage":"ì €ì¥ì†Œ","detail":"ì„¸ë¶€ì„¤ì •"}
    active_idx = tabs.index(active) + 1

    st.markdown('<div id="bottom-nav">', unsafe_allow_html=True)
    c1,c2,c3,c4 = st.columns(4)
    if c1.button(labels["chat"], use_container_width=True):       st.session_state.tab = "chat"
    if c2.button(labels["settings"], use_container_width=True):   st.session_state.tab = "settings"
    if c3.button(labels["storage"], use_container_width=True):    st.session_state.tab = "storage"
    if c4.button(labels["detail"], use_container_width=True):     st.session_state.tab = "detail"
    st.markdown('</div>', unsafe_allow_html=True)

    st.markdown(f"""
    <style>
      #bottom-nav {{
        position: fixed; left:0; right:0; bottom:0;
        padding: 8px 24px 10px; z-index: 40; background: transparent;
      }}
      div[data-testid="stChatInput"] {{
        position: fixed !important; left: 16px; right: 16px; bottom: 76px !important;
      }}
      div[data-testid="stChatInput"] label {{ display:none !important; }}
      div[data-testid="stChatInput"] textarea {{
        border-radius: 999px !important; border: 1px solid #E3E8EF !important;
        background: #fff !important; box-shadow: 0 6px 20px rgba(16,24,40,.08) !important;
        padding: 12px 16px !important;
      }}
      .main .block-container {{ padding-bottom: 280px !important; }}

      #bottom-nav .stButton > button {{
        background: transparent !important; border:0 !important; box-shadow:none !important;
        border-radius:0 !important; height:auto !important; padding:6px 0 4px !important;
        color:#64748B !important; font-weight:700; display:inline-flex; flex-direction:column; align-items:center; gap:4px;
      }}
      #bottom-nav .stButton > button::before {{
        content:""; width:24px; height:24px; display:block; margin:0 auto 4px;
        background-color:#64748B; -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
        -webkit-mask-position:center; mask-position:center;
        -webkit-mask-size:24px 24px; mask-size:24px 24px;
      }}
      #bottom-nav .stButton:nth-of-type(1) > button::before {{ -webkit-mask-image:url('{chat_uri}');    mask-image:url('{chat_uri}');    }}
      #bottom-nav .stButton:nth-of-type(2) > button::before {{ -webkit-mask-image:url('{settings_uri}');mask-image:url('{settings_uri}');}}
      #bottom-nav .stButton:nth-of-type(3) > button::before {{ -webkit-mask-image:url('{storage_uri}'); mask-image:url('{storage_uri}'); }}
      #bottom-nav .stButton:nth-of-type(4) > button::before {{ -webkit-mask-image:url('{detail_uri}');  mask-image:url('{detail_uri}');  }}
      #bottom-nav .stButton:nth-of-type({active_idx}) > button {{ color: var(--primary) !important; }}
      #bottom-nav .stButton:nth-of-type({active_idx}) > button::before {{ background-color: var(--primary) !important; }}
    </style>
    """, unsafe_allow_html=True)

# ================= ëª…ë ¹ ì¸ì‹(ì €ì¥) =================
SAVE_PATTERNS = [
    r"/save", r"ì €ì¥í•´ì¤˜", r"ì €ì¥í•´", r"ì €ì¥í•˜ê¸°", r"ì €ì¥ì†Œì—\s*ì €ì¥", r"ìê¸°ì†Œê°œì„œ.*ì €ì¥", r"ìƒì„±ëœ\s*ìê¸°ì†Œê°œì„œ.*ì €ì¥"
]
SAVE_REGEX = re.compile("|".join(SAVE_PATTERNS))
def is_save_command(txt:str)->bool:
    return bool(SAVE_REGEX.search(txt.replace(" ", "")))

def handle_save_command():
    last_bot = None
    for role, text, ts in reversed(st.session_state.msgs):
        if role == "bot":
            last_bot = text; break
    if not last_bot:
        st.session_state.msgs.append(("bot","ì €ì¥í•  ìê¸°ì†Œê°œì„œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € â€˜ëŒ€í™”â€™ì—ì„œ ì´ˆì•ˆì„ ìƒì„±í•´ ì£¼ì„¸ìš”.", now_hhmm()))
        return
    paths = save_last_result_all("ìê¸°ì†Œê°œì„œ", last_bot)
    if not paths:  return
    font_path, _ = _find_korean_font()
    msg = "ì €ì¥ ì™„ë£Œ!\n\n" + "\n".join(f"- {p}" for p in paths)
    if not font_path:
        msg += "\n\nâ€» PDF í•œê¸€ìš© ê¸€ê¼´ì´ ì—†ì–´ì„œ í•œê¸€ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nassets/fonts/NanumGothic.ttf ë¥¼ ì¶”ê°€í•˜ë©´ í•´ê²°ë©ë‹ˆë‹¤."
    st.session_state.msgs.append(("bot", msg, now_hhmm()))

# ================= í™”ë©´ë“¤ =================
def screen_onboarding():
    header_card("ìê¸°ì†Œê°œì„œ ì½”ì¹˜", "ëŒ€í™”ë¡œ ì´ˆì•ˆ ë§Œë“¤ê¸°")
    st.markdown("""
    <div style="display:flex;align-items:center;justify-content:center;height:64vh">
      <div style="width:88%;max-width:520px;background:#F5FBFB;border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:28px;text-align:center">
        <div style="font-size:56px;margin-bottom:12px">ğŸ¤–</div>
        <div style="font-weight:800;font-size:22px;margin:6px 0 8px">AI ìê¸°ì†Œê°œì„œ ì‘ì„±</div>
        <div style="color:#475569;line-height:1.6">
          AIê°€ ë„ì™€ì£¼ëŠ” ë§ì¶¤í˜• ìê¸°ì†Œê°œì„œë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”.<br/>
          ê°„ë‹¨í•œ ëŒ€í™”ë¥¼ í†µí•´ ì „ë¬¸ì ì¸ ìê¸°ì†Œê°œì„œë¥¼ ì™„ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>
    """, unsafe_allow_html=True)
    if st.button("ì‹œì‘í•˜ê¸°", use_container_width=True):
        st.session_state.screen = "main"; st.session_state.tab = "chat"

def screen_chat():
    header_card("ìê¸°ì†Œê°œì„œ ì½”ì¹˜", "ëŒ€í™”ë¡œ ì´ˆì•ˆ ë§Œë“¤ê¸°")
    for role, text, ts in st.session_state.msgs:
        ts = ts or now_hhmm()
        if role=="bot":
            st.markdown(
                f'<div class="bubble bot"><div class="bubble-text">{safe_html(text)}</div>'
                f'<div class="bubble-time">{ts}</div></div>', unsafe_allow_html=True)
        else:
            st.markdown(
                f'<div class="bubble me"><div class="bubble-text">{safe_html(text)}</div>'
                f'<div class="bubble-time">{ts}</div></div>', unsafe_allow_html=True)

    user = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...")
    if user:
        if is_save_command(user):
            handle_save_command()
        else:
            st.session_state.msgs.append(("user", user, now_hhmm()))
            with st.spinner("ìƒì„± ì¤‘â€¦"):
                reply = generate_cover_letter(user); time.sleep(0.2)
            st.session_state.msgs.append(("bot", reply, now_hhmm()))
    bottom_tabs("chat")

def screen_settings():
    header_card("í™˜ê²½ ì„¤ì •", "ëª¨ë¸Â·ê¸¸ì´Â·ì°½ì˜ì„± ì¡°ì ˆ")
    s = st.session_state.settings
    s["provider"] = {"demo(í‚¤ ì—†ìŒ)":"demo","openai":"openai","gemini":"gemini"}[
        st.selectbox("ì—”ì§„ ì œê³µì", ["demo(í‚¤ ì—†ìŒ)","openai","gemini"],
                     index={"demo":0,"openai":1,"gemini":2}.get(s["provider"],0))
    ]
    if s["provider"]=="openai":
        s["openai_key"] = st.text_input("OpenAI API Key", type="password", placeholder="sk-...")
        s["model"] = st.selectbox("OpenAI ëª¨ë¸", ["gpt-4o-mini","gpt-4o"], index=0)
    elif s["provider"]=="gemini":
        s["gemini_key"] = st.text_input("Gemini API Key", type="password", placeholder="AIza...")
        s["model"] = st.selectbox("Gemini ëª¨ë¸", ["gemini-1.5-pro","gemini-1.5-flash"], index=1)
    else:
        st.caption("ë°ëª¨ ëª¨ë“œ: ì‹¤ì œ í˜¸ì¶œ ì—†ì´ ì˜ˆì‹œ ì‘ë‹µì…ë‹ˆë‹¤.")
    s["tone"] = st.selectbox("í†¤(ì–´ì¡°)", ["ì •ì¤‘í•˜ê³  ê°„ê²°í•œ","ë”°ëœ»í•˜ê³  ì§„ì •ì„± ìˆëŠ”","ë…¼ë¦¬ì ì´ê³  ì§ì„¤ì ì¸"],
                             index=["ì •ì¤‘í•˜ê³  ê°„ê²°í•œ","ë”°ëœ»í•˜ê³  ì§„ì •ì„± ìˆëŠ”","ë…¼ë¦¬ì ì´ê³  ì§ì„¤ì ì¸"].index(s["tone"]))
    s["length"] = st.slider("ëª©í‘œ ê¸€ì ìˆ˜", 300, 1500, s["length"], 50)
    s["temperature"] = st.slider("ì°½ì˜ì„±(temperature)", 0.0, 1.0, s.get("temperature",0.7), 0.05)
    bottom_tabs("settings")

def screen_storage():
    header_card("ì €ì¥ì†Œ", "ë‚´ PCì—ì„œ íŒŒì¼ ë‚´ë ¤ë°›ê¸°")
    path = st.session_state.settings["save_dir"]
    ok, msg = ensure_dir(path)
    if not ok:
        st.error(msg)
    else:
        st.caption(f"ì €ì¥ ê²½ë¡œ: {path}")
        files = sorted([f for f in os.listdir(path) if f.endswith((".txt",".md",".docx",".pdf"))])
        if not files:
            st.info("ì•„ì§ ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            for name in files:
                with open(os.path.join(path,name),"rb") as f:
                    st.download_button(f"ë‹¤ìš´ë¡œë“œ: {name}", data=f.read(), file_name=name, use_container_width=True)
    bottom_tabs("storage")

def screen_detail():
    header_card("ì„¸ë¶€ì„¤ì •", "ìƒì„± ê²°ê³¼ ì €ì¥/ë‚´ë³´ë‚´ê¸°/ë²ˆì—­")
    if st.session_state.msgs and st.session_state.msgs[-1][0]=="bot":
        last = st.session_state.msgs[-1][1]
        title = st.text_input("íŒŒì¼ ì œëª©", value="ìê¸°ì†Œê°œì„œ")
        c1,c2,c3,c4 = st.columns(4)
        with c1:
            if st.button("ì €ì¥ì†Œì— ì €ì¥", use_container_width=True):
                paths = save_last_result_all(title, last)
                st.success("ì €ì¥ ì™„ë£Œ!\n" + "\n".join(paths))
        with c2:
            st.download_button("DOCX", data=to_docx_bytes(last),
                file_name=f"{slugify(title)}.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                use_container_width=True)
        with c3:
            st.download_button("PDF", data=to_pdf_bytes(last),
                file_name=f"{slugify(title)}.pdf", mime="application/pdf",
                use_container_width=True)
        with c4:
            if st.button("ì˜ë¬¸ ë³€í™˜", use_container_width=True):
                with st.spinner("ì˜ë¬¸ ë³€í™˜ ì¤‘â€¦"):
                    en = generate_cover_letter(f"[ì˜ë¬¸ ë²ˆì—­]\n{last}"); time.sleep(0.2)
                st.session_state.msgs.append(("bot", f"**ì˜ë¬¸ ë³€í™˜ë³¸**\n\n{en}", now_hhmm()))
                st.success("ëŒ€í™”ì— ì˜ë¬¸ ë³€í™˜ë³¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        st.info("ë¨¼ì € â€˜ëŒ€í™”â€™ íƒ­ì—ì„œ ë‚´ìš©ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.")
    bottom_tabs("detail")

# ================= ë¼ìš°íŒ… =================
if st.session_state.screen == "onboarding":
    screen_onboarding()
else:
    {"chat":screen_chat, "settings":screen_settings, "storage":screen_storage, "detail":screen_detail}[st.session_state.tab]()
